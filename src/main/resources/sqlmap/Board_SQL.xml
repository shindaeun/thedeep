<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="BoardSpace">

	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="searchVO" type="thedeep.service.DefaultVO"/>
	<typeAlias  alias="boardVO" type="thedeep.service.BoardVO"/>
	<typeAlias  alias="reviewVO" type="thedeep.service.ReviewVO"/>

	<select id="boardDAO.selectQnaList" resultClass="egovMap">
	SELECT b.* FROM (
   			SELECT rownum rn, a.* FROM (
   				SELECT 
   					unq, title, name, to_char(rdate, 'yyyy-mm-dd') rdate, nvl(filename,0) filename
   				FROM 
   					qna
   				WHERE 
   					1=1
   					<isNotNull property="searchKeyword">
   						<isNotEmpty property="searchKeyword">
   							AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
   						</isNotEmpty>
   					</isNotNull>
   				ORDER BY unq DESC
			) a
		) b
   			
   		WHERE
   		
   			rn >= $firstIndex$ AND rn <![CDATA[<=]]> $lastIndex$
	</select>
	
	<select id="boardDAO.selectQnaListTotCnt" resultClass="java.lang.Integer">
   		SELECT COUNT(*)
   		FROM qna
   		WHERE 
   			1=1
   			<isNotNull property="searchKeyword">
				<isNotEmpty property="searchKeyword">
					AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
				</isNotEmpty>
   			</isNotNull>
   </select>
   
   <select id="boardDAO.selectQnaImage" resultClass="boardVO">
   	<![CDATA[
   		SELECT	unq unq,
				nvl(filename,'') filename,
				nvl(filesize,0) filesize
		FROM qna
		WHERE unq = #unq#
	]]>
   </select>
   
   <insert id="boardDAO.insertUpload">
         INSERT INTO qna
            (  unq 
			, name
			, pwd
			, title
			, content
			, rdate
			, hit
			, forder
			<isNotNull property="filename">
				<isNotEmpty property="filename">
			, filename
			, filesize
				</isNotEmpty>
   			</isNotNull>
			)
         VALUES ( qna_seq.nextval
             	 , #name#
             	 , #pwd#
             	 , #title#
             	 , #content#
             	 , sysdate
             	 , '0'
             	 , 'a'
             	 <isNotNull property="filename">
             	 	<isNotEmpty property="filename">
             	 , #filename#
             	 , #filesize#
             	 	</isNotEmpty>
             	 </isNotNull>
             	 ) 
   </insert>
   
    <insert id="boardDAO.insertReview">
         INSERT INTO review
            (  unq
            , userid
            <isNotNull property="pcode">
				<isNotEmpty property="pcode">
			, pcode
				</isNotEmpty>
   			</isNotNull>
			, name
			, pwd
			, title
			, height
			, weight
			, psize
			, fit
			, content
			, rdate
			, hit
			<isNotNull property="filename">
				<isNotEmpty property="filename">
			, filename
				</isNotEmpty>
   			</isNotNull>
			)
         VALUES ( review_seq.nextval
         		, #userid#
         		<isNotNull property="pcode">
					<isNotEmpty property="pcode">
				, #pcode#
					</isNotEmpty>
   				</isNotNull>
             	 , #name#
             	 , #pwd#
             	 , #title#
             	 , #height#
             	 , #weight#
             	 , #psize#
             	 , #fit#
             	 , #content#
             	 , sysdate
             	 , '0'
             	 <isNotNull property="filename">
             	 	<isNotEmpty property="filename">
             	 , #filename#
             	 	</isNotEmpty>
             	 </isNotNull>
             	 ) 
   </insert>
   
   <select id="boardDAO.selectReviewList" resultClass="egovMap">
	
	SELECT b.* FROM (
	
	SELECT rownum rn,a.* FROM (
	
		SELECT 
			unq unq,
			pcode pcode,
			title title,
			name name,
			to_char(rdate,'yyyy-mm-dd') rdate,
			nvl(hit,0) hit
		FROM
			review 
		WHERE
			1 = 1
			<isNotNull property="searchKeyword">
				<isNotEmpty property="searchKeyword">
			AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
				</isNotEmpty>
			</isNotNull>
		ORDER BY unq DESC 
		) a
	) b
	
	WHERE 
		  rn > $firstIndex$ AND rn <![CDATA[<=]]> $lastIndex$ 

	</select>
	
	<select id="boardDAO.selectReviewListTotCnt" 
							resultClass = "java.lang.Integer">
		SELECT COUNT(*) FROM review
			WHERE
				1 = 1
				<isNotNull property="searchKeyword">
					<isNotEmpty property="searchKeyword">
				AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
					</isNotEmpty>
				</isNotNull>
	</select>

	<select id="boardDAO.selectReviewDetail" resultClass="reviewVO">
		SELECT 
			unq unq,
			title title,
			name name,
			height height,
			weight weight,
			psize psize,
			fit fit,
			content content,
			filename filename,
			(SELECT nvl(min(unq),0) FROM review WHERE unq > #unq#) nexInt,
			(SELECT nvl(max(unq),0) FROM review WHERE unq <![CDATA[<]]> #unq#) befInt
		FROM
			review
		WHERE 
			unq = #unq#
	</select>
	
	<update id="boardDAO.updateHit">
		UPDATE review SET 
			hit = hit+1
		WHERE
			unq = #unq#
	</update>
	
	<select id="boardDAO.selectReviewPwd" resultClass = "java.lang.Integer">
		SELECT count(unq)
		FROM review
		where unq=#unq#
		AND pwd=#pwd#
	</select>
	
	<delete id="boardDAO.deleteReview">
		DELETE FROM review
		WHERE unq = #unq#
	</delete>
	
	<update id="boardDAO.updateReviewFile">
		UPDATE review SET 
			filename = #filename#
		WHERE
			unq = #unq#
	</update>
	<select id="boardDAO.selectNowFilename" resultClass="java.lang.String">
		select nvl(filename,'') filename from review where unq=#unq#
	</select>
	
	<update id="boardDAO.updateReview">
		UPDATE review SET
			title = #title#,
			height = #height#,
			weight = #weight#,
			psize = #psize#,
			fit = #fit#,
			content = #content#,
			filename = #filename#
		WHERE
			unq = #unq#
	</update>
	
</sqlMap>
