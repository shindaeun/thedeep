<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="EmpSpace">

	<typeAlias alias="egovMap"
		type="egovframework.rte.psl.dataaccess.util.EgovMap" />
	<typeAlias alias="searchVO" type="thedeep.service.DefaultVO" />
	<typeAlias alias="groupVO" type="thedeep.service.GroupVO" />
	<typeAlias alias="productVO" type="thedeep.service.ProductVO" />
	<select id="productDAO.selectReviewResult" resultClass="egovMap">
	select i.*, sum(cnt)over() total 
	from(
		select height,weight,psize,fit,count(fit) cnt  
		from review 
		where lower(pcode)=lower(#pcode#)
		and height=#height# 
		and weight=#weight# 
		and psize=#psize# 
		group by fit,height,weight,psize) i
	</select>
	<select id="productDAO.selectReview" resultClass="egovMap">
		select b.*
		from(
		select
		rownum rn,a.*
		from(
		SELECT
		unq unq,
		title title,
		content content,
		hit
		hit,
		to_char(rdate,'yyyy-mm-dd') rdate
		FROM
		review
		WHERE
		1=1
		<isNotNull property="searchKeyword">
			<isNotEmpty property="searchKeyword">
				AND lower($searchCondition$) LIKE '%' ||
				lower(#searchKeyword#) || '%'
			</isNotEmpty>
		</isNotNull>
		ORDER BY
		unq DESC
		) a
		) b
		where
		rn > $firstIndex$ and rn  <![CDATA[<=]]>
		$lastIndex$
	</select>
	
	<select id="productDAO.selectReviewTotCnt" resultClass="java.lang.Integer">
	SELECT
		count(unq)
		FROM
		review
		WHERE
		1=1
		<isNotNull property="searchKeyword">
			<isNotEmpty property="searchKeyword">
				AND lower($searchCondition$) LIKE '%' || lower(#searchKeyword#) || '%'
			</isNotEmpty>
		</isNotNull>
		ORDER BY
		unq DESC
	</select>
	<select id="productDAO.selectQna" resultClass="egovMap">
		select b.*
		from(
		select
		rownum rn,a.*
		from(
		SELECT
		unq unq,
		title title,
		content content,
		hit
		hit,
		to_char(rdate,'yyyy-mm-dd') rdate
		FROM
		qna
		WHERE
		1=1
		<isNotNull property="searchKeyword">
			<isNotEmpty property="searchKeyword">
				AND lower($searchCondition$) LIKE '%' ||
				lower(#searchKeyword#) || '%'
			</isNotEmpty>
		</isNotNull>
		ORDER BY
		unq DESC
		) a
		) b
		where
		rn > $firstIndex$ and rn  <![CDATA[<=]]>
		$lastIndex$
	</select>
	
	<select id="productDAO.selectQnaTotCnt" resultClass="java.lang.Integer">
	SELECT
		count(unq)
		FROM
		qna
		WHERE
		1=1
		<isNotNull property="searchKeyword">
			<isNotEmpty property="searchKeyword">
				AND lower($searchCondition$) LIKE '%' || lower(#searchKeyword#) || '%'
			</isNotEmpty>
		</isNotNull>
		ORDER BY
		unq DESC
	</select>
	<select id="productDAO.selectBest3Product" resultClass="egovMap">
		select pp.pcode,pname,price,filename from(
		select p.pcode,sum(amount) amount from orderList l,product p
		where p.pcode=l.pcode
		and lower(gcode)=lower('g002')
		group by p.pcode
		order by amount desc) i,product pp
		where i.pcode=pp.pcode and rownum<![CDATA[<=]]>3
	</select>
	<select id="productDAO.selectProductList" resultClass="egovMap">
		select b.*
		from(
		select
		rownum rn,a.*
		from(
		SELECT
		distinct
		pcode,pname,price,mainfile,filename
		FROM
		product
		WHERE
		lower($searchCondition$) =
		lower(#searchKeyword#)
		ORDER BY
		pcode DESC
		) a
		) b
		where
		rn > $firstIndex$ and rn  <![CDATA[<=]]>
		$lastIndex$
	</select>

	<select id="productDAO.selectProductTotCnt" resultClass="java.lang.Integer">
		SELECT
		count(pcode)
		FROM
		product
		WHERE
		lower(gcode)=lower(#gcode#)
		ORDER BY
		pcode DESC
	</select>
	<select id="productDAO.selectProductInfo" resultClass="productVO">
		select distinct pcode,pname,price,price*0.01 point ,filename,mainfile
		from product
		where lower(pcode)=lower(#pcode#)
	</select>
	<select id="productDAO.selectSelOptions" resultClass="egovMap">
		select
		'color-'||color||' size-'|| psize as seloption,amount
		from stock
		where lower(pcode)=lower(#pcode#)
	</select>

	<select id="productDAO.selectGroupList" resultClass="egovMap">
		SELECT
		gcode,gname FROM productgroup
		ORDER BY gcode ASC
	</select>

	<select id="productDAO.selectGroup" resultClass="groupVO">
		SELECT
		gcode,gname FROM productgroup
		WHERE gcode=#gcode#
	</select>

	<insert id="productDAO.insertgroup">
		INSERT INTO productgroup(gcode,gname)
		VALUES (#gcode#,#gname#)
	</insert>

	<update id="productDAO.updateGroup">
		UPDATE productgroup SET
		gname = #gname#
		WHERE
		gcode = #gcode#
	</update>

	<delete id="productDAO.deleteGroup">
		DELETE FROM productgroup WHERE gcode = #gcode#
	</delete>
	
	<select id="productDAO.selectGname" resultClass="egovMap">
		select gname,gcode from productgroup
	</select>
	
	<insert id="productDAO.insertProduct">
		insert into product(
			  cscode
			, pcode
			, pname
			, price
			, gcode
			, soldout
			, wait
			<isNotNull property="editor">
			<isNotEmpty property="editor">
			, editor
			</isNotEmpty>
			</isNotNull>
			<isNotNull property="mainfile">
			<isNotEmpty property="mainfile">
			, mainfile
			</isNotEmpty>
			</isNotNull> )
		values (
			  'P'||lpad(#maxpcode#,'5','0')||#psize#||#color#
			, 'P'||lpad(#maxpcode#,'5','0')
			, #pname#
			, #price#
			, #gcode#
			, 'Y'
			, #wait#
			<isNotNull property="editor">
			<isNotEmpty property="editor">
			, #editor#
			</isNotEmpty>
			</isNotNull>
			<isNotNull property="mainfile">
			<isNotEmpty property="mainfile">
			, #mainfile#
			</isNotEmpty>
			</isNotNull>)
	</insert>
	
	<select id="productDAO.selectPcode" resultClass="java.lang.Integer">
		select product_seq.nextval
		from dual
	</select>
	
	<insert id="productDAO.insertProductStock">
		insert into stock(
			  cscode
			, pcode
			, psize
			, color
			, amount )
		values (
			 'P'||lpad(#maxpcode#,'5','0')||#psize#||#color#
		   , 'P'||lpad(#maxpcode#,'5','0')
		   , #psize#
		   , #color#
		   , 0)
	</insert>
	
	
	<select id="productDAO.selectProductListView" resultClass="egovMap">
	
	SELECT b.* FROM (
	
	SELECT rownum rn,a.* FROM (
	
		SELECT p.cscode ,p.pcode ,p.pname ,p.price ,p.soldout,p.wait, s.amount, g.GNAME
  		  FROM product p, stock s, productgroup g
         WHERE p.cscode = s.cscode
  		   AND p.GCODE = g.GCODE
			<isNotNull property="searchKeyword">
				<isNotEmpty property="searchKeyword">
					AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
				</isNotEmpty>
			</isNotNull>
		ORDER BY cscode DESC 
		) a
	) b
	
	WHERE 
		  rn > $firstIndex$ AND rn <![CDATA[<=]]> $lastIndex$ 

	</select>
	
	<select id="productDAO.selectProductListTotCnt" resultClass = "java.lang.Integer">
		SELECT COUNT(*) FROM product p
			WHERE
				1 = 1
				<isNotNull property="searchKeyword">
					<isNotEmpty property="searchKeyword">
				AND $searchCondition$ LIKE '%' || #searchKeyword# || '%'
					</isNotEmpty>
				</isNotNull>
	</select>
	
	<update id="productDAO.updateAmount">
		UPDATE stock SET
			amount = amount+(#amount#)
		WHERE
			cscode = #cscode#
	</update>
	
	<select id="productDAO.selectProductDetail" resultClass = "productVO">
		select distinct(pcode) pcode ,pname ,price ,gcode ,wait ,mainfile
		from product
		where pcode=#pcode#
	</select>
	
	<update id="productDAO.updateProductFile">
		update product set mainfile=#mainfile#
		where pcode=#pcode#
	</update>
	
	<delete id="productDAO.deleteProduct">
		DELETE from product where pcode=#pcode#
	</delete>
	
	<delete id="productDAO.deleteCsProduct">
		DELETE from product where cscode=#cscode#
	</delete>
	
	<insert id="productDAO.insertProductModify">
		insert into product(
			  cscode
			, pcode
			, pname
			, price
			, gcode
			, soldout
			, wait
			<isNotNull property="mainfile">
			<isNotEmpty property="mainfile">
			, mainfile
			</isNotEmpty>
			</isNotNull> )
		values (
			  #pcode#||#psize#||#color#
			, #pcode#
			, #pname#
			, #price#
			, #gcode#
			, 'Y'
			, #wait#
			<isNotNull property="mainfile">
			<isNotEmpty property="mainfile">
			, #mainfile#
			</isNotEmpty>
			</isNotNull>)
	</insert>
	
	<insert id="productDAO.insertProductStockModify">
		insert into stock(
			  cscode
			, pcode
			, psize
			, color
			, amount )
		values (
			 #pcode#||#psize#||#color#
		   , #pcode#
		   , #psize#
		   , #color#
		   , 0)
	</insert>
	
	<update id="productDAO.updateSoldout">
		update product set soldout='Y'
		where cscode=#cscode#
	</update>
	
	<update id="productDAO.updateProduct">
		update product set
			pname=#pname#
			,price=#price#
			,gcode=#gcode#
			,wait=#wait#
			<isNotNull property="mainfile">
			<isNotEmpty property="mainfile">
			,mainfile=#mainfile#
			</isNotEmpty>
			</isNotNull>
		where pcode=#pcode#
	</update>
	
	<select id="productDAO.selectAmount" resultClass="java.lang.Integer">
		select amount from stock where cscode=#cscode#
	</select>
	
	<update id="productDAO.updateNotSoldout">
		update product set soldout='N'
		where cscode=#cscode#
	</update>
	
	<select id="productDAO.selectCsList" resultClass="egovMap">
		select color,psize from stock where pcode=#pcode#
	</select> 
</sqlMap>
